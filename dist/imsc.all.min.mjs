import t from"stream";import e from"string_decoder";function n(t){var e={exports:{}};return t(e,e.exports),e.exports}var i=n((function(t,e){!function(t){t.ns_tt="http://www.w3.org/ns/ttml",t.ns_tts="http://www.w3.org/ns/ttml#styling",t.ns_ttp="http://www.w3.org/ns/ttml#parameter",t.ns_xml="http://www.w3.org/XML/1998/namespace",t.ns_itts="http://www.w3.org/ns/ttml/profile/imsc1#styling",t.ns_ittp="http://www.w3.org/ns/ttml/profile/imsc1#parameter",t.ns_smpte="http://www.smpte-ra.org/schemas/2052-1/2010/smpte-tt",t.ns_ebutts="urn:ebu:tt:style",t.ttaf_map={"http://www.w3.org/2006/10/ttaf1":t.ns_tt,"http://www.w3.org/2006/10/ttaf1#style":t.ns_tts,"http://www.w3.org/2006/10/ttaf1#parameter":t.ns_ttp}}(e)})),r=n((function(t,e){!function(t){var e=/#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})?/,n=/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/,i=/rgba\(\s*(\d+),\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/,r={transparent:[0,0,0,0],black:[0,0,0,255],silver:[192,192,192,255],gray:[128,128,128,255],white:[255,255,255,255],maroon:[128,0,0,255],red:[255,0,0,255],purple:[128,0,128,255],fuchsia:[255,0,255,255],magenta:[255,0,255,255],green:[0,128,0,255],lime:[0,255,0,255],olive:[128,128,0,255],yellow:[255,255,0,255],navy:[0,0,128,255],blue:[0,0,255,255],teal:[0,128,128,255],aqua:[0,255,255,255],cyan:[0,255,255,255]};t.parseColor=function(t){var o,s=null,l=r[t.toLowerCase()];return void 0!==l?s=l:null!==(o=e.exec(t))?s=[parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16),void 0!==o[4]?parseInt(o[4],16):255]:null!==(o=n.exec(t))?s=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3]),255]:null!==(o=i.exec(t))&&(s=[parseInt(o[1]),parseInt(o[2]),parseInt(o[3]),parseInt(o[4])]),s};var o=/^((?:\+|\-)?\d*(?:\.\d+)?)(px|em|c|%|rh|rw)$/;t.parseLength=function(t){var e,n=null;return null!==(e=o.exec(t))&&(n={value:parseFloat(e[1]),unit:e[2]}),n},t.parseTextShadow=function(e){var n=e.split(","),i=[];for(var r in n){var o=n[r].split(" ");if(1===o.length&&"none"===o[0])return"none";if(o.length>1&&o.length<5){var s=[null,null,null,null],l=t.parseLength(o.shift());if(null===l)return null;if(s[0]=l,null===(l=t.parseLength(o.shift())))return null;if(s[1]=l,0===o.length){i.push(s);continue}if(null!==(l=t.parseLength(o[0]))&&(s[2]=l,o.shift()),0===o.length){i.push(s);continue}var a=t.parseColor(o[0]);if(null===a)return null;s[3]=a,i.push(s)}}return i},t.parsePosition=function(e){var n=e.split(" "),i=function(t){return"center"===t||"left"===t||"top"===t||"bottom"===t||"right"===t};if(n.length>4)return null;for(var r in n)if(!i(n[r])){var o=t.parseLength(n[r]);if(null===o)return null;n[r]=o}for(var s={h:{edge:"left",offset:{value:50,unit:"%"}},v:{edge:"top",offset:{value:50,unit:"%"}}},l=0;l<n.length;){var a=n[l++];if(i(a)){var u={value:0,unit:"%"};2!==n.length&&l<n.length&&!i(n[l])&&(u=n[l++]),"right"===a?(s.h.edge=a,s.h.offset=u):"bottom"===a?(s.v.edge=a,s.v.offset=u):"left"===a?s.h.offset=u:"top"===a&&(s.v.offset=u)}else{if(1!==n.length&&2!==n.length)return null;1===l?s.h.offset=a:s.v.offset=a}}return s},t.ComputedLength=function(t,e){this.rw=t,this.rh=e},t.ComputedLength.prototype.toUsedLength=function(t,e){return t*this.rw+e*this.rh},t.ComputedLength.prototype.isZero=function(){return 0===this.rw&&0===this.rh},t.toComputedLength=function(e,n,i,r,o,s){return"%"===n&&r?new t.ComputedLength(r.rw*e/100,r.rh*e/100):"em"===n&&i?new t.ComputedLength(i.rw*e,i.rh*e):"c"===n&&o?new t.ComputedLength(e*o.rw,e*o.rh):"px"===n&&s?new t.ComputedLength(e*s.rw,e*s.rh):"rh"===n?new t.ComputedLength(0,e/100):"rw"===n?new t.ComputedLength(e/100,0):null}}(e)})),o=n((function(t,e){!function(t,e,n){function i(t,e,n,i,r,o,s,l){this.name=e,this.ns=t,this.qname=t+" "+e,this.inherit=r,this.animatable=o,this.initial=n,this.applies=i,this.parse=s,this.compute=l}for(var r in t.all=[new i(e.ns_tts,"backgroundColor","transparent",["body","div","p","region","span"],!1,!0,n.parseColor,null),new i(e.ns_tts,"color","white",["span"],!0,!0,n.parseColor,null),new i(e.ns_tts,"direction","ltr",["p","span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"display","auto",["body","div","p","region","span"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"displayAlign","before",["region"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"extent","auto",["tt","region"],!1,!0,(function(t){if("auto"===t)return t;var e=t.split(" ");if(2!==e.length)return null;var i=n.parseLength(e[0]),r=n.parseLength(e[1]);return r&&i?{h:r,w:i}:null}),(function(t,e,i,r,o){var s,l;if("auto"===r)s=new n.ComputedLength(0,1);else if(null===(s=n.toComputedLength(r.h.value,r.h.unit,null,t.dimensions.h,null,t.pxLength.h)))return null;if("auto"===r)l=new n.ComputedLength(1,0);else if(null===(l=n.toComputedLength(r.w.value,r.w.unit,null,t.dimensions.w,null,t.pxLength.w)))return null;return{h:s,w:l}})),new i(e.ns_tts,"fontFamily","default",["span"],!0,!0,(function(t){var e=t.split(","),n=[];for(var i in e)"'"!==e[i].charAt(0)&&'"'!==e[i].charAt(0)&&"default"===e[i]?n.push("monospaceSerif"):n.push(e[i]);return n}),null),new i(e.ns_tts,"shear","0%",["p"],!0,!0,n.parseLength,(function(t,e,n,i){return"%"!==i.unit?null:Math.abs(i.value)>100?100*Math.sign(i.value):i.value})),new i(e.ns_tts,"fontSize","1c",["span"],!0,!0,n.parseLength,(function(e,i,r,o,s){return n.toComputedLength(o.value,o.unit,null!==i?i.styleAttrs[t.byName.fontSize.qname]:e.cellLength.h,null!==i?i.styleAttrs[t.byName.fontSize.qname]:e.cellLength.h,e.cellLength.h,e.pxLength.h)})),new i(e.ns_tts,"fontStyle","normal",["span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"fontWeight","normal",["span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"lineHeight","normal",["p"],!0,!0,(function(t){return"normal"===t?t:n.parseLength(t)}),(function(e,i,r,o,s){var l;if("normal"===o)l=o;else if(null===(l=n.toComputedLength(o.value,o.unit,r.styleAttrs[t.byName.fontSize.qname],r.styleAttrs[t.byName.fontSize.qname],e.cellLength.h,e.pxLength.h)))return null;return l})),new i(e.ns_tts,"opacity",1,["region"],!1,!0,parseFloat,null),new i(e.ns_tts,"origin","auto",["region"],!1,!0,(function(t){if("auto"===t)return t;var e=t.split(" ");if(2!==e.length)return null;var i=n.parseLength(e[0]),r=n.parseLength(e[1]);return r&&i?{h:r,w:i}:null}),(function(t,e,i,r,o){var s,l;if("auto"===r)s=new n.ComputedLength(0,0);else if(null===(s=n.toComputedLength(r.h.value,r.h.unit,null,t.dimensions.h,null,t.pxLength.h)))return null;if("auto"===r)l=new n.ComputedLength(0,0);else if(null===(l=n.toComputedLength(r.w.value,r.w.unit,null,t.dimensions.w,null,t.pxLength.w)))return null;return{h:s,w:l}})),new i(e.ns_tts,"overflow","hidden",["region"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"padding","0px",["region"],!1,!0,(function(t){var e=t.split(" ");if(e.length>4)return null;var i=[];for(var r in e){var o=n.parseLength(e[r]);if(!o)return null;i.push(o)}return i}),(function(e,i,r,o,s){var l;if(1===o.length)l=[o[0],o[0],o[0],o[0]];else if(2===o.length)l=[o[0],o[1],o[0],o[1]];else if(3===o.length)l=[o[0],o[1],o[2],o[1]];else{if(4!==o.length)return null;l=[o[0],o[1],o[2],o[3]]}var a=r.styleAttrs[t.byName.writingMode.qname];if("lrtb"===a||"lr"===a)l=[l[0],l[3],l[2],l[1]];else if("rltb"===a||"rl"===a)l=[l[0],l[1],l[2],l[3]];else if("tblr"===a)l=[l[3],l[0],l[1],l[2]];else{if("tbrl"!==a&&"tb"!==a)return null;l=[l[3],l[2],l[1],l[0]]}var u=[];for(var c in l)if(0===l[c].value)u[c]=new n.ComputedLength(0,0);else if(u[c]=n.toComputedLength(l[c].value,l[c].unit,r.styleAttrs[t.byName.fontSize.qname],"0"===c||"2"===c?r.styleAttrs[t.byName.extent.qname].h:r.styleAttrs[t.byName.extent.qname].w,"0"===c||"2"===c?e.cellLength.h:e.cellLength.w,"0"===c||"2"===c?e.pxLength.h:e.pxLength.w),null===u[c])return null;return u})),new i(e.ns_tts,"position","top left",["region"],!1,!0,(function(t){return n.parsePosition(t)}),(function(e,i,r,o){var s,l;return null===(s=n.toComputedLength(o.v.offset.value,o.v.offset.unit,null,new n.ComputedLength(-r.styleAttrs[t.byName.extent.qname].h.rw,e.dimensions.h.rh-r.styleAttrs[t.byName.extent.qname].h.rh),null,e.pxLength.h))?null:("bottom"===o.v.edge&&(s=new n.ComputedLength(-s.rw-r.styleAttrs[t.byName.extent.qname].h.rw,e.dimensions.h.rh-s.rh-r.styleAttrs[t.byName.extent.qname].h.rh)),l=n.toComputedLength(o.h.offset.value,o.h.offset.unit,null,new n.ComputedLength(e.dimensions.w.rw-r.styleAttrs[t.byName.extent.qname].w.rw,-r.styleAttrs[t.byName.extent.qname].w.rh),null,e.pxLength.w),null===s?null:("right"===o.h.edge&&(l=new n.ComputedLength(e.dimensions.w.rw-l.rw-r.styleAttrs[t.byName.extent.qname].w.rw,-l.rh-r.styleAttrs[t.byName.extent.qname].w.rh)),{h:s,w:l}))})),new i(e.ns_tts,"ruby","none",["span"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"rubyAlign","center",["span"],!0,!0,(function(t){return"center"!==t&&"spaceAround"!==t?null:t}),null),new i(e.ns_tts,"rubyPosition","outside",["span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"rubyReserve","none",["p"],!0,!0,(function(t){var e=t.split(" "),i=[null,null];if(0===e.length||e.length>2)return null;if("none"!==e[0]&&"both"!==e[0]&&"after"!==e[0]&&"before"!==e[0]&&"outside"!==e[0])return null;if(i[0]=e[0],2===e.length&&"none"!==e[0]){var r=n.parseLength(e[1]);if(!r)return null;i[1]=r}return i}),(function(e,i,r,o,s){if("none"===o[0])return o;var l=null;return null===(l=null===o[1]?new n.ComputedLength(.5*r.styleAttrs[t.byName.fontSize.qname].rw,.5*r.styleAttrs[t.byName.fontSize.qname].rh):n.toComputedLength(o[1].value,o[1].unit,r.styleAttrs[t.byName.fontSize.qname],r.styleAttrs[t.byName.fontSize.qname],e.cellLength.h,e.pxLength.h))?null:[o[0],l]})),new i(e.ns_tts,"showBackground","whenActive",["region"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"textAlign","start",["p"],!0,!0,(function(t){return t}),(function(t,e,n,i,r){return"left"===i?"start":"right"===i?"end":i})),new i(e.ns_tts,"textCombine","none",["span"],!0,!0,(function(t){var e=t.split(" ");return 1!==e.length||"none"!==e[0]&&"all"!==e[0]?null:[e[0]]}),null),new i(e.ns_tts,"textDecoration","none",["span"],!0,!0,(function(t){return t.split(" ")}),null),new i(e.ns_tts,"textEmphasis","none",["span"],!0,!0,(function(t){var e=t.split(" "),i={style:null,symbol:null,color:null,position:null};for(var r in e)if("none"===e[r]||"auto"===e[r])i.style=e[r];else if("filled"===e[r]||"open"===e[r])i.style=e[r];else if("circle"===e[r]||"dot"===e[r]||"sesame"===e[r])i.symbol=e[r];else if("current"===e[r])i.color=e[r];else if("outside"===e[r]||"before"===e[r]||"after"===e[r])i.position=e[r];else if(i.color=n.parseColor(e[r]),null===i.color)return null;return null==i.style&&null==i.symbol?i.style="auto":(i.symbol=i.symbol||"circle",i.style=i.style||"filled"),i.position=i.position||"outside",i.color=i.color||"current",i}),null),new i(e.ns_tts,"textOutline","none",["span"],!0,!0,(function(t){if("none"===t)return t;var e={},i=t.split(" ");if(0===i.length||i.length>2)return null;var r=n.parseColor(i[0]);if(e.color=r,null!==r&&i.shift(),1!==i.length)return null;var o=n.parseLength(i[0]);return o?(e.thickness=o,e):null}),(function(e,i,r,o,s){if("none"===o)return o;var l={};return null===o.color?l.color=r.styleAttrs[t.byName.color.qname]:l.color=o.color,l.thickness=n.toComputedLength(o.thickness.value,o.thickness.unit,r.styleAttrs[t.byName.fontSize.qname],r.styleAttrs[t.byName.fontSize.qname],e.cellLength.h,e.pxLength.h),null===l.thickness?null:l})),new i(e.ns_tts,"textShadow","none",["span"],!0,!0,n.parseTextShadow,(function(e,i,r,o){if("none"===o)return o;var s=[];for(var l in o){var a={};if(a.x_off=n.toComputedLength(o[l][0].value,o[l][0].unit,null,r.styleAttrs[t.byName.fontSize.qname],null,e.pxLength.w),null===a.x_off)return null;if(a.y_off=n.toComputedLength(o[l][1].value,o[l][1].unit,null,r.styleAttrs[t.byName.fontSize.qname],null,e.pxLength.h),null===a.y_off)return null;if(null===o[l][2])a.b_radius=0;else if(a.b_radius=n.toComputedLength(o[l][2].value,o[l][2].unit,null,r.styleAttrs[t.byName.fontSize.qname],null,e.pxLength.h),null===a.b_radius)return null;null===o[l][3]?a.color=r.styleAttrs[t.byName.color.qname]:a.color=o[l][3],s.push(a)}return s})),new i(e.ns_tts,"unicodeBidi","normal",["span","p"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"visibility","visible",["body","div","p","region","span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"wrapOption","wrap",["span"],!0,!0,(function(t){return t}),null),new i(e.ns_tts,"writingMode","lrtb",["region"],!1,!0,(function(t){return t}),null),new i(e.ns_tts,"zIndex","auto",["region"],!1,!0,(function(t){var e;return"auto"===t?e=t:(e=parseInt(t),isNaN(e)&&(e=null)),e}),null),new i(e.ns_ebutts,"linePadding","0c",["p"],!0,!1,n.parseLength,(function(t,e,i,r,o){return n.toComputedLength(r.value,r.unit,null,null,t.cellLength.w,null)})),new i(e.ns_ebutts,"multiRowAlign","auto",["p"],!0,!1,(function(t){return t}),null),new i(e.ns_smpte,"backgroundImage",null,["div"],!1,!1,(function(t){return t}),null),new i(e.ns_itts,"forcedDisplay","false",["body","div","p","region","span"],!0,!0,(function(t){return"true"===t}),null),new i(e.ns_itts,"fillLineGap","true",["p"],!0,!0,(function(t){return"true"===t}),null)],t.byQName={},t.all)t.byQName[t.all[r].qname]=t.all[r];for(var o in t.byName={},t.all)t.byName[t.all[o].name]=t.all[o]}(e,"undefined"==typeof imscNames?i:imscNames,"undefined"==typeof imscUtils?r:imscUtils)})),s=n((function(t,e){!function(t,e,n,i){t.generateISD=function(t,e,n){var i=new a(t),r={};for(var s in t.head.layout.regions){var l=o(t,e,t.head.layout.regions[s],t.body,null,"",t.head.layout.regions[s],n,r);null!==l&&i.contents.push(l.element)}return i};var r=[n.byName.color.qname,n.byName.textCombine.qname,n.byName.textDecoration.qname,n.byName.textEmphasis.qname,n.byName.textOutline.qname,n.byName.textShadow.qname];function o(t,e,a,p,f,d,m,h,g){if(e<m.begin||e>=m.end)return null;var y="regionID"in m&&""!==m.regionID?m.regionID:d;if(null!==f&&y!==a.id&&(!("contents"in m)||"contents"in m&&0===m.contents.length||""!==y))return null;var b=new u(m);for(var w in m.sets)e<m.sets[w].begin||e>=m.sets[w].end||(b.styleAttrs[m.sets[w].qname]=m.sets[w].value);var v,N={};for(var T in b.styleAttrs)if(N[T]=!0,T===n.byName.writingMode.qname&&!(n.byName.direction.qname in b.styleAttrs)){var x=b.styleAttrs[T];"lrtb"===x||"lr"===x?b.styleAttrs[n.byName.direction.qname]="ltr":"rltb"!==x&&"rl"!==x||(b.styleAttrs[n.byName.direction.qname]="rtl")}if(null!==f)for(var _ in n.all){var A=n.all[_];if(A.qname===n.byName.textDecoration.qname){var E=f.styleAttrs[A.qname],C=b.styleAttrs[A.qname],I=[];void 0===C?I=E:-1===C.indexOf("none")?((-1===C.indexOf("noUnderline")&&-1!==E.indexOf("underline")||-1!==C.indexOf("underline"))&&I.push("underline"),(-1===C.indexOf("noLineThrough")&&-1!==E.indexOf("lineThrough")||-1!==C.indexOf("lineThrough"))&&I.push("lineThrough"),(-1===C.indexOf("noOverline")&&-1!==E.indexOf("overline")||-1!==C.indexOf("overline"))&&I.push("overline")):I.push("none"),b.styleAttrs[A.qname]=I}else if(A.qname!==n.byName.fontSize.qname||A.qname in b.styleAttrs||"span"!==b.kind||"textContainer"!==b.styleAttrs[n.byName.ruby.qname])if(A.qname!==n.byName.fontSize.qname||A.qname in b.styleAttrs||"span"!==b.kind||"text"!==b.styleAttrs[n.byName.ruby.qname])A.inherit&&A.qname in f.styleAttrs&&!(A.qname in b.styleAttrs)&&(b.styleAttrs[A.qname]=f.styleAttrs[A.qname]);else{var L=f.styleAttrs[n.byName.fontSize.qname];"textContainer"===f.styleAttrs[n.byName.ruby.qname]?b.styleAttrs[A.qname]=L:b.styleAttrs[A.qname]=new i.ComputedLength(.5*L.rw,.5*L.rh)}else{var S=f.styleAttrs[n.byName.fontSize.qname];b.styleAttrs[A.qname]=new i.ComputedLength(.5*S.rw,.5*S.rh)}}for(var F in n.all){var D=n.all[F];if(!(D.qname in b.styleAttrs)&&!(D.qname===n.byName.position.qname&&n.byName.origin.qname in b.styleAttrs||D.qname===n.byName.origin.qname&&n.byName.position.qname in b.styleAttrs)){var R=t.head.styling.initials[D.qname]||D.initial;("region"===b.kind||!1===D.inherit&&null!==R)&&(b.styleAttrs[D.qname]=D.parse(R),N[D.qname]=!0)}}for(var q in n.all){var O=n.all[q];if(O.qname in N&&null!==O.compute){var P=O.compute(t,f,b,b.styleAttrs[O.qname],g);null!==P?b.styleAttrs[O.qname]=P:(b.styleAttrs[O.qname]=O.compute(t,f,b,O.parse(O.initial),g),c(h,"Style '"+O.qname+"' on element '"+b.kind+"' cannot be computed"))}}if("none"===b.styleAttrs[n.byName.display.qname])return null;for(var U in null===f?v=null===p?[]:[p]:"contents"in m&&(v=m.contents),v){var M=o(t,e,a,p,b,y,v[U],h,g);null!==M&&b.contents.push(M.element)}for(var k in b.styleAttrs){var B=!1;if("span"===b.kind){var G=b.styleAttrs[n.byName.ruby.qname];(B=("container"===G||"textContainer"===G||"baseContainer"===G)&&-1!==r.indexOf(k))||(B="container"!==G&&k===n.byName.rubyAlign.qname),B||(B=!("textContainer"===G||"text"===G)&&k===n.byName.rubyPosition.qname)}if(!B)B=-1===n.byQName[k].applies.indexOf(b.kind);B&&delete b.styleAttrs[k]}if("span"===b.kind&&b.text&&"default"===b.space){var V=b.text.replace(/[\t\r\n ]+/g," ");b.text=V}if("p"===b.kind){var z=[];s(b,z);for(var Y=0,W="after_br",X=0;;)if("after_br"===W)Y>=z.length||"br"===z[Y].kind?(W="before_br",X=Y,Y--):("preserve"!==z[Y].space&&(z[Y].text=z[Y].text.replace(/^[\t\r\n ]+/g,"")),z[Y].text.length>0?(W="looking_br",Y++):z.splice(Y,1));else if("before_br"===W)if(Y<0||"br"===z[Y].kind){if(W="after_br",(Y=X+1)>=z.length)break}else if("preserve"!==z[Y].space&&(z[Y].text=z[Y].text.replace(/[\t\r\n ]+$/g,"")),z[Y].text.length>0){if(W="after_br",(Y=X+1)>=z.length)break}else z.splice(Y,1),Y--;else Y>=z.length||"br"===z[Y].kind?(W="before_br",X=Y,Y--):Y++;l(b)}return"div"===b.kind&&n.byName.backgroundImage.qname in b.styleAttrs||"br"===b.kind||"image"===b.kind||"contents"in b&&b.contents.length>0||"span"===b.kind&&null!==b.text||"region"===b.kind&&"always"===b.styleAttrs[n.byName.showBackground.qname]?{region_id:y,element:b}:null}function s(t,e){if("contents"in t)for(var n in t.contents)s(t.contents[n],e);else"span"!==t.kind&&"br"!==t.kind||e.push(t)}function l(t){if("br"===t.kind)return!1;if("text"in t)return 0===t.text.length;if("contents"in t){for(var e=t.contents.length;e--;)l(t.contents[e])&&t.contents.splice(e,1);return 0===t.contents.length}}function a(t){this.contents=[],this.aspectRatio=t.aspectRatio}function u(t){for(var e in this.kind=t.kind||"region",t.id&&(this.id=t.id),this.styleAttrs={},t.styleAttrs)this.styleAttrs[e]=t.styleAttrs[e];"src"in t&&(this.src=t.src),"type"in t&&(this.type=t.type),"text"in t?this.text=t.text:("region"===this.kind||"contents"in t)&&(this.contents=[]),"space"in t&&(this.space=t.space)}function c(t,e){if(t&&t.error&&t.error(e))throw e}}(e,"undefined"==typeof imscNames||imscNames,"undefined"==typeof imscStyles?o:imscStyles,"undefined"==typeof imscUtils?r:imscUtils)})),l=n((function(n,i){!function(n){n.parser=function(t,e){return new o(t,e)},n.SAXParser=o,n.SAXStream=l,n.createStream=function(t,e){return new l(t,e)},n.MAX_BUFFER_LENGTH=65536;var i,r=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function o(t,e){if(!(this instanceof o))return new o(t,e);var i=this;!function(t){for(var e=0,n=r.length;e<n;e++)t[r[e]]=""}(i),i.q=i.c="",i.bufferCheckPosition=n.MAX_BUFFER_LENGTH,i.opt=e||{},i.opt.lowercase=i.opt.lowercase||i.opt.lowercasetags,i.looseCase=i.opt.lowercase?"toLowerCase":"toUpperCase",i.tags=[],i.closed=i.closedRoot=i.sawRoot=!1,i.tag=i.error=null,i.strict=!!t,i.noscript=!(!t&&!i.opt.noscript),i.state=E.BEGIN,i.strictEntities=i.opt.strictEntities,i.ENTITIES=i.strictEntities?Object.create(n.XML_ENTITIES):Object.create(n.ENTITIES),i.attribList=[],i.opt.xmlns&&(i.ns=Object.create(h)),i.trackPosition=!1!==i.opt.position,i.trackPosition&&(i.position=i.line=i.column=0),I(i,"onready")}n.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(t){function e(){}return e.prototype=t,new e}),Object.keys||(Object.keys=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}),o.prototype={end:function(){R(this)},write:function(t){var e=this;if(this.error)throw this.error;if(e.closed)return D(e,"Cannot write after close. Assign an onready handler.");if(null===t)return R(e);"object"==typeof t&&(t=t.toString());var i=0,o="";for(;o=V(t,i++),e.c=o,o;)switch(e.trackPosition&&(e.position++,"\n"===o?(e.line++,e.column=0):e.column++),e.state){case E.BEGIN:if(e.state=E.BEGIN_WHITESPACE,"\ufeff"===o)continue;G(e,o);continue;case E.BEGIN_WHITESPACE:G(e,o);continue;case E.TEXT:if(e.sawRoot&&!e.closedRoot){for(var s=i-1;o&&"<"!==o&&"&"!==o;)(o=V(t,i++))&&e.trackPosition&&(e.position++,"\n"===o?(e.line++,e.column=0):e.column++);e.textNode+=t.substring(s,i-1)}"<"!==o||e.sawRoot&&e.closedRoot&&!e.strict?(!T(a,o)||e.sawRoot&&!e.closedRoot||q(e,"Text data outside of root node."),"&"===o?e.state=E.TEXT_ENTITY:e.textNode+=o):(e.state=E.OPEN_WAKA,e.startTagPosition=e.position);continue;case E.SCRIPT:"<"===o?e.state=E.SCRIPT_ENDING:e.script+=o;continue;case E.SCRIPT_ENDING:"/"===o?e.state=E.CLOSE_TAG:(e.script+="<"+o,e.state=E.SCRIPT);continue;case E.OPEN_WAKA:if("!"===o)e.state=E.SGML_DECL,e.sgmlDecl="";else if(N(a,o));else if(N(g,o))e.state=E.OPEN_TAG,e.tagName=o;else if("/"===o)e.state=E.CLOSE_TAG,e.tagName="";else if("?"===o)e.state=E.PROC_INST,e.procInstName=e.procInstBody="";else{if(q(e,"Unencoded <"),e.startTagPosition+1<e.position){var l=e.position-e.startTagPosition;o=new Array(l).join(" ")+o}e.textNode+="<"+o,e.state=E.TEXT}continue;case E.SGML_DECL:"[CDATA["===(e.sgmlDecl+o).toUpperCase()?(L(e,"onopencdata"),e.state=E.CDATA,e.sgmlDecl="",e.cdata=""):e.sgmlDecl+o==="--"?(e.state=E.COMMENT,e.comment="",e.sgmlDecl=""):"DOCTYPE"===(e.sgmlDecl+o).toUpperCase()?(e.state=E.DOCTYPE,(e.doctype||e.sawRoot)&&q(e,"Inappropriately located doctype declaration"),e.doctype="",e.sgmlDecl=""):">"===o?(L(e,"onsgmldeclaration",e.sgmlDecl),e.sgmlDecl="",e.state=E.TEXT):N(p,o)?(e.state=E.SGML_DECL_QUOTED,e.sgmlDecl+=o):e.sgmlDecl+=o;continue;case E.SGML_DECL_QUOTED:o===e.q&&(e.state=E.SGML_DECL,e.q=""),e.sgmlDecl+=o;continue;case E.DOCTYPE:">"===o?(e.state=E.TEXT,L(e,"ondoctype",e.doctype),e.doctype=!0):(e.doctype+=o,"["===o?e.state=E.DOCTYPE_DTD:N(p,o)&&(e.state=E.DOCTYPE_QUOTED,e.q=o));continue;case E.DOCTYPE_QUOTED:e.doctype+=o,o===e.q&&(e.q="",e.state=E.DOCTYPE);continue;case E.DOCTYPE_DTD:e.doctype+=o,"]"===o?e.state=E.DOCTYPE:N(p,o)&&(e.state=E.DOCTYPE_DTD_QUOTED,e.q=o);continue;case E.DOCTYPE_DTD_QUOTED:e.doctype+=o,o===e.q&&(e.state=E.DOCTYPE_DTD,e.q="");continue;case E.COMMENT:"-"===o?e.state=E.COMMENT_ENDING:e.comment+=o;continue;case E.COMMENT_ENDING:"-"===o?(e.state=E.COMMENT_ENDED,e.comment=F(e.opt,e.comment),e.comment&&L(e,"oncomment",e.comment),e.comment=""):(e.comment+="-"+o,e.state=E.COMMENT);continue;case E.COMMENT_ENDED:">"!==o?(q(e,"Malformed comment"),e.comment+="--"+o,e.state=E.COMMENT):e.state=E.TEXT;continue;case E.CDATA:"]"===o?e.state=E.CDATA_ENDING:e.cdata+=o;continue;case E.CDATA_ENDING:"]"===o?e.state=E.CDATA_ENDING_2:(e.cdata+="]"+o,e.state=E.CDATA);continue;case E.CDATA_ENDING_2:">"===o?(e.cdata&&L(e,"oncdata",e.cdata),L(e,"onclosecdata"),e.cdata="",e.state=E.TEXT):"]"===o?e.cdata+="]":(e.cdata+="]]"+o,e.state=E.CDATA);continue;case E.PROC_INST:"?"===o?e.state=E.PROC_INST_ENDING:N(a,o)?e.state=E.PROC_INST_BODY:e.procInstName+=o;continue;case E.PROC_INST_BODY:if(!e.procInstBody&&N(a,o))continue;"?"===o?e.state=E.PROC_INST_ENDING:e.procInstBody+=o;continue;case E.PROC_INST_ENDING:">"===o?(L(e,"onprocessinginstruction",{name:e.procInstName,body:e.procInstBody}),e.procInstName=e.procInstBody="",e.state=E.TEXT):(e.procInstBody+="?"+o,e.state=E.PROC_INST_BODY);continue;case E.OPEN_TAG:N(y,o)?e.tagName+=o:(O(e),">"===o?M(e):"/"===o?e.state=E.OPEN_TAG_SLASH:(T(a,o)&&q(e,"Invalid character in tag name"),e.state=E.ATTRIB));continue;case E.OPEN_TAG_SLASH:">"===o?(M(e,!0),k(e)):(q(e,"Forward-slash in opening tag not followed by >"),e.state=E.ATTRIB);continue;case E.ATTRIB:if(N(a,o))continue;">"===o?M(e):"/"===o?e.state=E.OPEN_TAG_SLASH:N(g,o)?(e.attribName=o,e.attribValue="",e.state=E.ATTRIB_NAME):q(e,"Invalid attribute name");continue;case E.ATTRIB_NAME:"="===o?e.state=E.ATTRIB_VALUE:">"===o?(q(e,"Attribute without value"),e.attribValue=e.attribName,U(e),M(e)):N(a,o)?e.state=E.ATTRIB_NAME_SAW_WHITE:N(y,o)?e.attribName+=o:q(e,"Invalid attribute name");continue;case E.ATTRIB_NAME_SAW_WHITE:if("="===o)e.state=E.ATTRIB_VALUE;else{if(N(a,o))continue;q(e,"Attribute without value"),e.tag.attributes[e.attribName]="",e.attribValue="",L(e,"onattribute",{name:e.attribName,value:""}),e.attribName="",">"===o?M(e):N(g,o)?(e.attribName=o,e.state=E.ATTRIB_NAME):(q(e,"Invalid attribute name"),e.state=E.ATTRIB)}continue;case E.ATTRIB_VALUE:if(N(a,o))continue;N(p,o)?(e.q=o,e.state=E.ATTRIB_VALUE_QUOTED):(q(e,"Unquoted attribute value"),e.state=E.ATTRIB_VALUE_UNQUOTED,e.attribValue=o);continue;case E.ATTRIB_VALUE_QUOTED:if(o!==e.q){"&"===o?e.state=E.ATTRIB_VALUE_ENTITY_Q:e.attribValue+=o;continue}U(e),e.q="",e.state=E.ATTRIB_VALUE_CLOSED;continue;case E.ATTRIB_VALUE_CLOSED:N(a,o)?e.state=E.ATTRIB:">"===o?M(e):"/"===o?e.state=E.OPEN_TAG_SLASH:N(g,o)?(q(e,"No whitespace between attributes"),e.attribName=o,e.attribValue="",e.state=E.ATTRIB_NAME):q(e,"Invalid attribute name");continue;case E.ATTRIB_VALUE_UNQUOTED:if(T(f,o)){"&"===o?e.state=E.ATTRIB_VALUE_ENTITY_U:e.attribValue+=o;continue}U(e),">"===o?M(e):e.state=E.ATTRIB;continue;case E.CLOSE_TAG:if(e.tagName)">"===o?k(e):N(y,o)?e.tagName+=o:e.script?(e.script+="</"+e.tagName,e.tagName="",e.state=E.SCRIPT):(T(a,o)&&q(e,"Invalid tagname in closing tag"),e.state=E.CLOSE_TAG_SAW_WHITE);else{if(N(a,o))continue;T(g,o)?e.script?(e.script+="</"+o,e.state=E.SCRIPT):q(e,"Invalid tagname in closing tag."):e.tagName=o}continue;case E.CLOSE_TAG_SAW_WHITE:if(N(a,o))continue;">"===o?k(e):q(e,"Invalid characters in closing tag");continue;case E.TEXT_ENTITY:case E.ATTRIB_VALUE_ENTITY_Q:case E.ATTRIB_VALUE_ENTITY_U:var u,c;switch(e.state){case E.TEXT_ENTITY:u=E.TEXT,c="textNode";break;case E.ATTRIB_VALUE_ENTITY_Q:u=E.ATTRIB_VALUE_QUOTED,c="attribValue";break;case E.ATTRIB_VALUE_ENTITY_U:u=E.ATTRIB_VALUE_UNQUOTED,c="attribValue"}";"===o?(e[c]+=B(e),e.entity="",e.state=u):N(e.entity.length?w:b,o)?e.entity+=o:(q(e,"Invalid character in entity name"),e[c]+="&"+e.entity+o,e.entity="",e.state=u);continue;default:throw new Error(e,"Unknown state: "+e.state)}e.position>=e.bufferCheckPosition&&function(t){for(var e=Math.max(n.MAX_BUFFER_LENGTH,10),i=0,o=0,s=r.length;o<s;o++){var l=t[r[o]].length;if(l>e)switch(r[o]){case"textNode":S(t);break;case"cdata":L(t,"oncdata",t.cdata),t.cdata="";break;case"script":L(t,"onscript",t.script),t.script="";break;default:D(t,"Max buffer length exceeded: "+r[o])}i=Math.max(i,l)}var a=n.MAX_BUFFER_LENGTH-i;t.bufferCheckPosition=a+t.position}(e);return e}
/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){var t;S(t=this),""!==t.cdata&&(L(t,"oncdata",t.cdata),t.cdata=""),""!==t.script&&(L(t,"onscript",t.script),t.script="")}};try{i=t.Stream}catch(t){i=function(){}}var s=n.EVENTS.filter((function(t){return"error"!==t&&"end"!==t}));function l(t,e){if(!(this instanceof l))return new l(t,e);i.apply(this),this._parser=new o(t,e),this.writable=!0,this.readable=!0;var n=this;this._parser.onend=function(){n.emit("end")},this._parser.onerror=function(t){n.emit("error",t),n._parser.error=null},this._decoder=null,s.forEach((function(t){Object.defineProperty(n,"on"+t,{get:function(){return n._parser["on"+t]},set:function(e){if(!e)return n.removeAllListeners(t),n._parser["on"+t]=e,e;n.on(t,e)},enumerable:!0,configurable:!1})}))}l.prototype=Object.create(i.prototype,{constructor:{value:l}}),l.prototype.write=function(t){if("function"==typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(t)){if(!this._decoder){var n=e.StringDecoder;this._decoder=new n("utf8")}t=this._decoder.write(t)}return this._parser.write(t.toString()),this.emit("data",t),!0},l.prototype.end=function(t){return t&&t.length&&this.write(t),this._parser.end(),!0},l.prototype.on=function(t,e){var n=this;return n._parser["on"+t]||-1===s.indexOf(t)||(n._parser["on"+t]=function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);e.splice(0,0,t),n.emit.apply(n,e)}),i.prototype.on.call(n,t,e)};var a="\r\n\t ",u="0124356789",c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",p="'\"",f=a+">",d="http://www.w3.org/XML/1998/namespace",m="http://www.w3.org/2000/xmlns/",h={xml:d,xmlns:m};a=v(a),u=v(u),c=v(c);var g=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,y=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040\.\d-]/,b=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,w=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040\.\d-]/;function v(t){return t.split("").reduce((function(t,e){return t[e]=!0,t}),{})}function N(t,e){return function(t){return"[object RegExp]"===Object.prototype.toString.call(t)}(t)?!!e.match(t):t[e]}function T(t,e){return!N(t,e)}p=v(p),f=v(f);var x,_,A,E=0;for(var C in n.STATE={BEGIN:E++,BEGIN_WHITESPACE:E++,TEXT:E++,TEXT_ENTITY:E++,OPEN_WAKA:E++,SGML_DECL:E++,SGML_DECL_QUOTED:E++,DOCTYPE:E++,DOCTYPE_QUOTED:E++,DOCTYPE_DTD:E++,DOCTYPE_DTD_QUOTED:E++,COMMENT_STARTING:E++,COMMENT:E++,COMMENT_ENDING:E++,COMMENT_ENDED:E++,CDATA:E++,CDATA_ENDING:E++,CDATA_ENDING_2:E++,PROC_INST:E++,PROC_INST_BODY:E++,PROC_INST_ENDING:E++,OPEN_TAG:E++,OPEN_TAG_SLASH:E++,ATTRIB:E++,ATTRIB_NAME:E++,ATTRIB_NAME_SAW_WHITE:E++,ATTRIB_VALUE:E++,ATTRIB_VALUE_QUOTED:E++,ATTRIB_VALUE_CLOSED:E++,ATTRIB_VALUE_UNQUOTED:E++,ATTRIB_VALUE_ENTITY_Q:E++,ATTRIB_VALUE_ENTITY_U:E++,CLOSE_TAG:E++,CLOSE_TAG_SAW_WHITE:E++,SCRIPT:E++,SCRIPT_ENDING:E++},n.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},n.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(n.ENTITIES).forEach((function(t){var e=n.ENTITIES[t],i="number"==typeof e?String.fromCharCode(e):e;n.ENTITIES[t]=i})),n.STATE)n.STATE[n.STATE[C]]=C;function I(t,e,n){t[e]&&t[e](n)}function L(t,e,n){t.textNode&&S(t),I(t,e,n)}function S(t){t.textNode=F(t.opt,t.textNode),t.textNode&&I(t,"ontext",t.textNode),t.textNode=""}function F(t,e){return t.trim&&(e=e.trim()),t.normalize&&(e=e.replace(/\s+/g," ")),e}function D(t,e){return S(t),t.trackPosition&&(e+="\nLine: "+t.line+"\nColumn: "+t.column+"\nChar: "+t.c),e=new Error(e),t.error=e,I(t,"onerror",e),t}function R(t){return t.sawRoot&&!t.closedRoot&&q(t,"Unclosed root tag"),t.state!==E.BEGIN&&t.state!==E.BEGIN_WHITESPACE&&t.state!==E.TEXT&&D(t,"Unexpected end"),S(t),t.c="",t.closed=!0,I(t,"onend"),o.call(t,t.strict,t.opt),t}function q(t,e){if("object"!=typeof t||!(t instanceof o))throw new Error("bad call to strictFail");t.strict&&D(t,e)}function O(t){t.strict||(t.tagName=t.tagName[t.looseCase]());var e=t.tags[t.tags.length-1]||t,n=t.tag={name:t.tagName,attributes:{}};t.opt.xmlns&&(n.ns=e.ns),t.attribList.length=0,L(t,"onopentagstart",n)}function P(t,e){var n=t.indexOf(":")<0?["",t]:t.split(":"),i=n[0],r=n[1];return e&&"xmlns"===t&&(i="xmlns",r=""),{prefix:i,local:r}}function U(t){if(t.strict||(t.attribName=t.attribName[t.looseCase]()),-1!==t.attribList.indexOf(t.attribName)||t.tag.attributes.hasOwnProperty(t.attribName))t.attribName=t.attribValue="";else{if(t.opt.xmlns){var e=P(t.attribName,!0),n=e.prefix,i=e.local;if("xmlns"===n)if("xml"===i&&t.attribValue!==d)q(t,"xml: prefix must be bound to "+d+"\nActual: "+t.attribValue);else if("xmlns"===i&&t.attribValue!==m)q(t,"xmlns: prefix must be bound to "+m+"\nActual: "+t.attribValue);else{var r=t.tag,o=t.tags[t.tags.length-1]||t;r.ns===o.ns&&(r.ns=Object.create(o.ns)),r.ns[i]=t.attribValue}t.attribList.push([t.attribName,t.attribValue])}else t.tag.attributes[t.attribName]=t.attribValue,L(t,"onattribute",{name:t.attribName,value:t.attribValue});t.attribName=t.attribValue=""}}function M(t,e){if(t.opt.xmlns){var n=t.tag,i=P(t.tagName);n.prefix=i.prefix,n.local=i.local,n.uri=n.ns[i.prefix]||"",n.prefix&&!n.uri&&(q(t,"Unbound namespace prefix: "+JSON.stringify(t.tagName)),n.uri=i.prefix);var r=t.tags[t.tags.length-1]||t;n.ns&&r.ns!==n.ns&&Object.keys(n.ns).forEach((function(e){L(t,"onopennamespace",{prefix:e,uri:n.ns[e]})}));for(var o=0,s=t.attribList.length;o<s;o++){var l=t.attribList[o],a=l[0],u=l[1],c=P(a,!0),p=c.prefix,f=c.local,d=""===p?"":n.ns[p]||"",m={name:a,value:u,prefix:p,local:f,uri:d};p&&"xmlns"!==p&&!d&&(q(t,"Unbound namespace prefix: "+JSON.stringify(p)),m.uri=p),t.tag.attributes[a]=m,L(t,"onattribute",m)}t.attribList.length=0}t.tag.isSelfClosing=!!e,t.sawRoot=!0,t.tags.push(t.tag),L(t,"onopentag",t.tag),e||(t.noscript||"script"!==t.tagName.toLowerCase()?t.state=E.TEXT:t.state=E.SCRIPT,t.tag=null,t.tagName=""),t.attribName=t.attribValue="",t.attribList.length=0}function k(t){if(!t.tagName)return q(t,"Weird empty close tag."),t.textNode+="</>",void(t.state=E.TEXT);if(t.script){if("script"!==t.tagName)return t.script+="</"+t.tagName+">",t.tagName="",void(t.state=E.SCRIPT);L(t,"onscript",t.script),t.script=""}var e=t.tags.length,n=t.tagName;t.strict||(n=n[t.looseCase]());for(var i=n;e--;){if(t.tags[e].name===i)break;q(t,"Unexpected close tag")}if(e<0)return q(t,"Unmatched closing tag: "+t.tagName),t.textNode+="</"+t.tagName+">",void(t.state=E.TEXT);t.tagName=n;for(var r=t.tags.length;r-- >e;){var o=t.tag=t.tags.pop();t.tagName=t.tag.name,L(t,"onclosetag",t.tagName);var s={};for(var l in o.ns)s[l]=o.ns[l];var a=t.tags[t.tags.length-1]||t;t.opt.xmlns&&o.ns!==a.ns&&Object.keys(o.ns).forEach((function(e){var n=o.ns[e];L(t,"onclosenamespace",{prefix:e,uri:n})}))}0===e&&(t.closedRoot=!0),t.tagName=t.attribValue=t.attribName="",t.attribList.length=0,t.state=E.TEXT}function B(t){var e,n=t.entity,i=n.toLowerCase(),r="";return t.ENTITIES[n]?t.ENTITIES[n]:t.ENTITIES[i]?t.ENTITIES[i]:("#"===(n=i).charAt(0)&&("x"===n.charAt(1)?(n=n.slice(2),r=(e=parseInt(n,16)).toString(16)):(n=n.slice(1),r=(e=parseInt(n,10)).toString(10))),n=n.replace(/^0+/,""),r.toLowerCase()!==n?(q(t,"Invalid character entity"),"&"+t.entity+";"):String.fromCodePoint(e))}function G(t,e){"<"===e?(t.state=E.OPEN_WAKA,t.startTagPosition=t.position):T(a,e)&&(q(t,"Non-whitespace before first tag."),t.textNode=e,t.state=E.TEXT)}function V(t,e){var n="";return e<t.length&&(n=t.charAt(e)),n}E=n.STATE,String.fromCodePoint||(x=String.fromCharCode,_=Math.floor,A=function(){var t,e,n=16384,i=[],r=-1,o=arguments.length;if(!o)return"";for(var s="";++r<o;){var l=Number(arguments[r]);if(!isFinite(l)||l<0||l>1114111||_(l)!==l)throw RangeError("Invalid code point: "+l);l<=65535?i.push(l):(t=55296+((l-=65536)>>10),e=l%1024+56320,i.push(t,e)),(r+1===o||i.length>n)&&(s+=x.apply(null,i),i.length=0)}return s},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:A,configurable:!0,writable:!0}):String.fromCodePoint=A)}(i)})),a=n((function(t,e){!function(t,e,n,i,r){function o(t,e){var n=t.styleAttrs&&t.styleAttrs["http://www.w3.org/ns/ttml#styling backgroundColor"];if("span"===t.kind)!n&&e&&(t.styleAttrs||(t.styleAttrs={}),t.styleAttrs["http://www.w3.org/ns/ttml#styling backgroundColor"]=e);else if(n&&delete t.styleAttrs["http://www.w3.org/ns/ttml#styling backgroundColor"],t.contents)for(var i=0;i<t.contents.length;i++)o(t.contents[i],n||e)}function s(t){if("contents"in t)for(var e=("styleAttrs"in t?t.styleAttrs[i.byName.ruby.qname]:null),n="span"===t.kind&&("container"===e||"textContainer"===e||"baseContainer"===e),r=t.contents.length-1;r>=0;r--)!n||"styleAttrs"in t.contents[r]&&i.byName.ruby.qname in t.contents[r].styleAttrs?s(t.contents[r]):delete t.contents[r]}function l(t,e,n,i){var r=i&&"seq"===i.timeContainer,o=0;i&&(o=r&&n?n.end:i.begin),e.begin=e.explicit_begin?e.explicit_begin+o:o;var s=e.begin,a=null;for(var u in e.sets)l(t,e.sets[u],a,e),s="seq"===e.timeContainer?e.sets[u].end:Math.max(s,e.sets[u].end),a=e.sets[u];if("contents"in e)for(var c in e.contents)l(t,e.contents[c],a,e),s="seq"===e.timeContainer?e.contents[c].end:Math.max(s,e.contents[c].end),a=e.contents[c];else s=r?e.begin:Number.POSITIVE_INFINITY;null!==e.explicit_end&&null!==e.explicit_dur?e.end=Math.min(e.begin+e.explicit_dur,o+e.explicit_end):null===e.explicit_end&&null!==e.explicit_dur?e.end=e.begin+e.explicit_dur:null!==e.explicit_end&&null===e.explicit_dur?e.end=o+e.explicit_end:e.end=s,delete e.explicit_begin,delete e.explicit_dur,delete e.explicit_end,t._registerEvent(e)}function a(t){this.node=t}function u(){this.events=[],this.head=new c,this.body=null}function c(){this.styling=new p,this.layout=new m}function p(){this.styles={},this.initials={}}function f(){this.id=null,this.styleAttrs=null,this.styleRefs=null}function d(){this.styleAttrs=null}function m(){this.regions={}}function h(t,e){g.call(this,"image"),this.src=t,this.type=e}function g(t){this.kind=t}function y(t){this.id=t}function b(t){this.regionID=t}function w(t){this.styleAttrs=t}function v(t){this.sets=t}function N(t){this.contents=t}function T(t,e,n){this.explicit_begin=t,this.explicit_end=e,this.explicit_dur=n}function x(){g.call(this,"body")}function _(){g.call(this,"div")}function A(){g.call(this,"p")}function E(){g.call(this,"span")}function C(){g.call(this,"span")}function I(){g.call(this,"br")}function L(){}function S(){}function F(t){var e=null;if(t){var n=t.attributes["xml:id"]||t.attributes.id;n&&(e=n.value||null)}return e}function D(t){return t&&"style"in t.attributes?t.attributes.style.value.split(" "):[]}function R(t,e){var n={};if(null!==t)for(var r in t.attributes){var o=t.attributes[r].uri+" "+t.attributes[r].local,s=i.byQName[o];if(void 0!==s){var l=s.parse(t.attributes[r].value);null!==l?(n[o]=l,s===i.byName.zIndex&&k(e,"zIndex attribute present but not used by IMSC1 since regions do not overlap")):B(e,"Cannot parse styling attribute "+o+" --\x3e "+t.attributes[r].value)}}return n}function q(t,e,n){for(var i in t.attributes)if(t.attributes[i].uri===e&&t.attributes[i].local===n)return t.attributes[i].value;return null}function O(t,e,n){var i,r=null;return null!==(i=/^(\d+(?:\.\d+)?)f$/.exec(n))?null!==e&&(r=parseFloat(i[1])/e):null!==(i=/^(\d+(?:\.\d+)?)t$/.exec(n))?null!==t&&(r=parseFloat(i[1])/t):null!==(i=/^(\d+(?:\.\d+)?)ms$/.exec(n))?r=parseFloat(i[1])/1e3:null!==(i=/^(\d+(?:\.\d+)?)s$/.exec(n))?r=parseFloat(i[1]):null!==(i=/^(\d+(?:\.\d+)?)h$/.exec(n))?r=3600*parseFloat(i[1]):null!==(i=/^(\d+(?:\.\d+)?)m$/.exec(n))?r=60*parseFloat(i[1]):null!==(i=/^(\d{2,}):(\d\d):(\d\d(?:\.\d+)?)$/.exec(n))?r=3600*parseInt(i[1])+60*parseInt(i[2])+parseFloat(i[3]):null!==(i=/^(\d{2,}):(\d\d):(\d\d)\:(\d{2,})$/.exec(n))&&null!==e&&(r=3600*parseInt(i[1])+60*parseInt(i[2])+parseInt(i[3])+(null===i[4]?0:parseInt(i[4])/e)),r}function P(t,e,n){for(;e.styleRefs.length>0;){var i=e.styleRefs.pop();i in t.styles?(P(t,t.styles[i],n),M(t.styles[i].styleAttrs,e.styleAttrs)):B(n,"Non-existant style id referenced")}}function U(t,e,n,i){for(var r=e.length-1;r>=0;r--){var o=e[r];o in t.styles?M(t.styles[o].styleAttrs,n):B(i,"Non-existant style id referenced")}}function M(t,e){for(var n in t)n in e||(e[n]=t[n])}function k(t,e){if(t&&t.warn&&t.warn(e))throw e}function B(t,e){if(t&&t.error&&t.error(e))throw e}function G(t,e){throw t&&t.fatal&&t.fatal(e),e}function V(t,e){for(var n,i=0,r=t.length-1;i<=r;){var o=t[n=Math.floor((i+r)/2)];if(o<e)i=n+1;else{if(!(o>e))return{found:!0,index:n};r=n-1}}return{found:!1,index:i}}t.fromXML=function(t,r,g){var y=e.parser(!0,{xmlns:!0}),b=[],w=[],v=[],N=0,T=null;y.onclosetag=function(t){if(b[0]instanceof p)for(var e in b[0].styles)P(b[0],b[0].styles[e],r);else if(b[0]instanceof A||b[0]instanceof E){if(b[0].contents.length>1){var i,o=[b[0].contents[0]];for(i=1;i<b[0].contents.length;i++)b[0].contents[i]instanceof C&&o[o.length-1]instanceof C?o[o.length-1].text+=b[0].contents[i].text:o.push(b[0].contents[i]);b[0].contents=o}b[0]instanceof E&&1===b[0].contents.length&&b[0].contents[0]instanceof C&&(b[0].text=b[0].contents[0].text,delete b[0].contents)}else b[0]instanceof a&&(b[0].node.uri===n.ns_tt&&"metadata"===b[0].node.local?N--:N>0&&g&&"onCloseTag"in g&&g.onCloseTag());v.shift(),w.shift(),b.shift()},y.ontext=function(t){if(void 0===b[0]);else if(b[0]instanceof E||b[0]instanceof A){if(b[0]instanceof E){var e=b[0].styleAttrs[i.byName.ruby.qname];if("container"===e||"textContainer"===e||"baseContainer"===e)return}var n=new C;n.initFromText(T,b[0],t,v[0],r),b[0].contents.push(n)}else b[0]instanceof a&&N>0&&g&&"onText"in g&&g.onText(t)},y.onopentag=function(t){var e=t.attributes["xml:space"];e?v.unshift(e.value):0===v.length?v.unshift("default"):v.unshift(v[0]);var o=t.attributes["xml:lang"];function s(t){n.ttaf_map[t.uri]&&(t.uri=n.ttaf_map[t.uri])}if(o?w.unshift(o.value):0===w.length?w.unshift(""):w.unshift(w[0]),s(t),t.attributes)for(var l in t.attributes)t.attributes.hasOwnProperty(l)&&s(t.attributes[l]);if(t.uri===n.ns_tt)if("tt"===t.local)null!==T&&G(r,"Two <tt> elements at ("+this.line+","+this.column+")"),(T=new u).initFromNode(t,r),b.unshift(T);else if("head"===t.local)b[0]instanceof u||G(r,"Parent of <head> element is not <tt> at ("+this.line+","+this.column+")"),b.unshift(T.head);else if("styling"===t.local)b[0]instanceof c||G(r,"Parent of <styling> element is not <head> at ("+this.line+","+this.column+")"),b.unshift(T.head.styling);else if("style"===t.local){var y;b[0]instanceof p?((y=new f).initFromNode(t,r),y.id?T.head.styling.styles[y.id]=y:B(r,"<style> element missing @id attribute"),b.unshift(y)):b[0]instanceof L?((y=new f).initFromNode(t,r),M(y.styleAttrs,b[0].styleAttrs),b.unshift(y)):G(r,"Parent of <style> element is not <styling> or <region> at ("+this.line+","+this.column+")")}else if("initial"===t.local){var C;if(b[0]instanceof p){for(var F in(C=new d).initFromNode(t,r),C.styleAttrs)T.head.styling.initials[F]=C.styleAttrs[F];b.unshift(C)}else G(r,"Parent of <initial> element is not <styling> at ("+this.line+","+this.column+")")}else if("layout"===t.local)b[0]instanceof c||G(r,"Parent of <layout> element is not <head> at "+this.line+","+this.column+")"),b.unshift(T.head.layout);else if("region"===t.local){b[0]instanceof m||G(r,"Parent of <region> element is not <layout> at "+this.line+","+this.column+")");var D=new L;D.initFromNode(T,t,r),!D.id||D.id in T.head.layout.regions?B(r,"Ignoring <region> with duplicate or missing @id at "+this.line+","+this.column+")"):T.head.layout.regions[D.id]=D,b.unshift(D)}else if("body"===t.local){b[0]instanceof u||G(r,"Parent of <body> element is not <tt> at "+this.line+","+this.column+")"),null!==T.body&&G(r,"Second <body> element at "+this.line+","+this.column+")");var R=new x;R.initFromNode(T,t,r),T.body=R,b.unshift(R)}else if("div"===t.local){b[0]instanceof _||b[0]instanceof x||G(r,"Parent of <div> element is not <body> or <div> at "+this.line+","+this.column+")");var q=new _;q.initFromNode(T,b[0],t,r);var O=q.styleAttrs[i.byName.backgroundImage.qname];O&&(q.contents.push(new h(O)),delete q.styleAttrs[i.byName.backgroundImage.qname]),b[0].contents.push(q),b.unshift(q)}else if("image"===t.local){b[0]instanceof _||G(r,"Parent of <image> element is not <div> at "+this.line+","+this.column+")");var P=new h;P.initFromNode(T,b[0],t,r),b[0].contents.push(P),b.unshift(P)}else if("p"===t.local){b[0]instanceof _||G(r,"Parent of <p> element is not <div> at "+this.line+","+this.column+")");var U=new A;U.initFromNode(T,b[0],t,r),b[0].contents.push(U),b.unshift(U)}else if("span"===t.local){b[0]instanceof E||b[0]instanceof A||G(r,"Parent of <span> element is not <span> or <p> at "+this.line+","+this.column+")");var k=new E;k.initFromNode(T,b[0],t,v[0],r),b[0].contents.push(k),b.unshift(k)}else if("br"===t.local){b[0]instanceof E||b[0]instanceof A||G(r,"Parent of <br> element is not <span> or <p> at "+this.line+","+this.column+")");var V=new I;V.initFromNode(T,b[0],t,r),b[0].contents.push(V),b.unshift(V)}else if("set"===t.local){b[0]instanceof E||b[0]instanceof A||b[0]instanceof _||b[0]instanceof x||b[0]instanceof L||b[0]instanceof I||G(r,"Parent of <set> element is not a content element or a region at "+this.line+","+this.column+")");var z=new S;z.initFromNode(T,b[0],t,r),b[0].sets.push(z),b.unshift(z)}else b.unshift(new a(t));else b.unshift(new a(t));if(b[0]instanceof a)if(t.uri===n.ns_tt&&"metadata"===t.local)N++;else if(N>0&&g&&"onOpenTag"in g){var Y=[];for(var W in t.attributes)Y[t.attributes[W].uri+" "+t.attributes[W].local]={uri:t.attributes[W].uri,local:t.attributes[W].local,value:t.attributes[W].value};g.onOpenTag(t.uri,t.local,Y)}},y.write(t).close(),delete T.head.styling.styles;var F=!1;for(var D in T.head.layout.regions){F=!0;break}if(!F){var R=L.prototype.createDefaultRegion(T,r);T.head.layout.regions[R.id]=R}for(var q in T.head.layout.regions)l(T,T.head.layout.regions[q],null,null);return T.body&&l(T,T.body,null,null),T.body&&s(T.body),T.body&&o(T.body),T},u.prototype.initFromNode=function(t,e){var i=function(t,e){var i=q(t,n.ns_ttp,"cellResolution"),r=15,o=32;if(null!==i){var s=/(\d+) (\d+)/.exec(i);null!==s?(o=parseInt(s[1]),r=parseInt(s[2])):k(e,"Malformed cellResolution value (using initial value instead)")}return{w:o,h:r}}(t,e);this.cellLength={h:new r.ComputedLength(0,1/i.h),w:new r.ComputedLength(1/i.w,0)};var o=function(t,e){var i,r=q(t,n.ns_ttp,"frameRate"),o=30;if(null!==r){null!==(i=/(\d+)/.exec(r))?o=parseInt(i[1]):k(e,"Malformed frame rate attribute (using initial value instead)")}var s=q(t,n.ns_ttp,"frameRateMultiplier"),l=1;if(null!==s){null!==(i=/(\d+) (\d+)/.exec(s))?l=parseInt(i[1])/parseInt(i[2]):k(e,"Malformed frame rate multiplier attribute (using initial value instead)")}var a=l*o,u=1,c=q(t,n.ns_ttp,"tickRate");if(null===c)null!==r&&(u=a);else{null!==(i=/(\d+)/.exec(c))?u=parseInt(i[1]):k(e,"Malformed tick rate attribute (using initial value instead)")}return{effectiveFrameRate:a,tickRate:u}}(t,e);this.effectiveFrameRate=o.effectiveFrameRate,this.tickRate=o.tickRate,this.aspectRatio=function(t,e){var i=q(t,n.ns_ittp,"aspectRatio");null===i&&(i=q(t,n.ns_ttp,"displayAspectRatio"));var r=null;if(null!==i){var o=/(\d+)\s+(\d+)/.exec(i);if(null!==o){var s=parseInt(o[1]),l=parseInt(o[2]);0!==s&&0!==l?r=s/l:B(e,"Illegal aspectRatio values (ignoring)")}else B(e,"Malformed aspectRatio attribute (ignoring)")}return r}(t,e);var s=q(t,n.ns_ttp,"timeBase");null!==s&&"media"!==s&&G(e,"Unsupported time base");var l=function(t,e){var i=q(t,n.ns_tts,"extent");if(null===i)return null;var o=i.split(" ");if(2!==o.length)return k(e,"Malformed extent (ignoring)"),null;var s=r.parseLength(o[0]),l=r.parseLength(o[1]);if(!l||!s)return k(e,"Malformed extent values (ignoring)"),null;return{h:l,w:s}}(t,e);null===l?this.pxLength={h:null,w:null}:("px"===l.h.unit&&"px"===l.w.unit||G(e,"Extent on TT must be in px or absent"),this.pxLength={h:new r.ComputedLength(0,1/l.h.value),w:new r.ComputedLength(1/l.w.value,0)}),this.dimensions={h:new r.ComputedLength(0,1),w:new r.ComputedLength(1,0)}},u.prototype._registerEvent=function(t){if(!(t.end<=t.begin)){var e=V(this.events,t.begin);if(e.found||this.events.splice(e.index,0,t.begin),t.end!==Number.POSITIVE_INFINITY){var n=V(this.events,t.end);n.found||this.events.splice(n.index,0,t.end)}}},u.prototype.getMediaTimeRange=function(){return[this.events[0],this.events[this.events.length-1]]},u.prototype.getMediaTimeEvents=function(){return this.events},f.prototype.initFromNode=function(t,e){this.id=F(t),this.styleAttrs=R(t,e),this.styleRefs=D(t)},d.prototype.initFromNode=function(t,e){for(var i in this.styleAttrs={},t.attributes)if(t.attributes[i].uri===n.ns_itts||t.attributes[i].uri===n.ns_ebutts||t.attributes[i].uri===n.ns_tts){var r=t.attributes[i].uri+" "+t.attributes[i].local;this.styleAttrs[r]=t.attributes[i].value}},h.prototype.initFromNode=function(t,e,n,i){this.src="src"in n.attributes?n.attributes.src.value:null,this.src||B(i,"Invalid image@src attribute"),this.type="type"in n.attributes?n.attributes.type.value:null,this.type||B(i,"Invalid image@type attribute"),w.prototype.initFromNode.call(this,t,e,n,i),T.prototype.initFromNode.call(this,t,e,n,i),v.prototype.initFromNode.call(this,t,e,n,i),b.prototype.initFromNode.call(this,t,e,n,i)},y.prototype.initFromNode=function(t,e,n,i){this.id=F(n)},b.prototype.initFromNode=function(t,e,n,i){this.regionID=function(t){return t&&"region"in t.attributes?t.attributes.region.value:""}(n)},w.prototype.initFromNode=function(t,e,n,i){this.styleAttrs=R(n,i),null!==t.head&&null!==t.head.styling&&U(t.head.styling,D(n),this.styleAttrs,i)},v.prototype.initFromNode=function(t,e,n,i){this.sets=[]},N.prototype.initFromNode=function(t,e,n,i){this.contents=[]},T.prototype.initFromNode=function(t,e,n,i){var r=function(t,e,n,i){var r=null;n&&"begin"in n.attributes&&null===(r=O(t.tickRate,t.effectiveFrameRate,n.attributes.begin.value))&&k(i,"Malformed begin value "+n.attributes.begin.value+" (using 0)");var o=null;n&&"dur"in n.attributes&&null===(o=O(t.tickRate,t.effectiveFrameRate,n.attributes.dur.value))&&k(i,"Malformed dur value "+n.attributes.dur.value+" (ignoring)");var s=null;n&&"end"in n.attributes&&null===(s=O(t.tickRate,t.effectiveFrameRate,n.attributes.end.value))&&k(i,"Malformed end value (ignoring)");return{explicit_begin:r,explicit_end:s,explicit_dur:o}}(t,0,n,i);this.explicit_begin=r.explicit_begin,this.explicit_end=r.explicit_end,this.explicit_dur=r.explicit_dur,this.timeContainer=function(t,e){var n=t&&"timeContainer"in t.attributes?t.attributes.timeContainer.value:null;return n&&"par"!==n?"seq"===n?"seq":(B(e,"Illegal value of timeContainer (assuming 'par')"),"par"):"par"}(n,i)},x.prototype.initFromNode=function(t,e,n){w.prototype.initFromNode.call(this,t,null,e,n),T.prototype.initFromNode.call(this,t,null,e,n),v.prototype.initFromNode.call(this,t,null,e,n),b.prototype.initFromNode.call(this,t,null,e,n),N.prototype.initFromNode.call(this,t,null,e,n)},_.prototype.initFromNode=function(t,e,n,i){w.prototype.initFromNode.call(this,t,e,n,i),T.prototype.initFromNode.call(this,t,e,n,i),v.prototype.initFromNode.call(this,t,e,n,i),b.prototype.initFromNode.call(this,t,e,n,i),N.prototype.initFromNode.call(this,t,e,n,i)},A.prototype.initFromNode=function(t,e,n,i){w.prototype.initFromNode.call(this,t,e,n,i),T.prototype.initFromNode.call(this,t,e,n,i),v.prototype.initFromNode.call(this,t,e,n,i),b.prototype.initFromNode.call(this,t,e,n,i),N.prototype.initFromNode.call(this,t,e,n,i)},E.prototype.initFromNode=function(t,e,n,i,r){w.prototype.initFromNode.call(this,t,e,n,r),T.prototype.initFromNode.call(this,t,e,n,r),v.prototype.initFromNode.call(this,t,e,n,r),b.prototype.initFromNode.call(this,t,e,n,r),N.prototype.initFromNode.call(this,t,e,n,r),this.space=i},C.prototype.initFromText=function(t,e,n,i,r){T.prototype.initFromNode.call(this,t,e,null,r),this.text=n,this.space=i},I.prototype.initFromNode=function(t,e,n,i){b.prototype.initFromNode.call(this,t,e,n,i),T.prototype.initFromNode.call(this,t,e,n,i)},L.prototype.createDefaultRegion=function(t,e){var n=new L,i={name:"region",attributes:{"tts:displayAlign":{name:"tts:displayAlign",value:"after",prefix:"tts",local:"displayAlign",uri:"http://www.w3.org/ns/ttml#styling"},"tts:extent":{name:"tts:extent",value:"80% 20%",prefix:"tts",local:"extent",uri:"http://www.w3.org/ns/ttml#styling"},"tts:origin":{name:"tts:origin",value:"10% 70%",prefix:"tts",local:"origin",uri:"http://www.w3.org/ns/ttml#styling"},"tts:overflow":{name:"tts:overflow",value:"visible",prefix:"tts",local:"overflow",uri:"http://www.w3.org/ns/ttml#styling"}},ns:{"":"http://www.w3.org/ns/ttml",ebuttm:"urn:ebu:tt:metadata",ebutts:"urn:ebu:tt:style",ittp:"http://www.w3.org/ns/ttml/profile/imsc1#parameter",itts:"http://www.w3.org/ns/ttml/profile/imsc1#styling",ttm:"http://www.w3.org/ns/ttml#metadata",ttp:"http://www.w3.org/ns/ttml#parameter",tts:"http://www.w3.org/ns/ttml#styling",xml:"http://www.w3.org/XML/1998/namespace"},prefix:"",local:"region",uri:"http://www.w3.org/ns/ttml",isSelfClosing:!0};return y.call(n,""),w.prototype.initFromNode.call(n,t,null,i,e),v.call(n,[]),T.call(n,0,Number.POSITIVE_INFINITY,null),n},L.prototype.initFromNode=function(t,e,n){y.prototype.initFromNode.call(this,t,null,e,n),w.prototype.initFromNode.call(this,t,null,e,n),T.prototype.initFromNode.call(this,t,null,e,n),v.prototype.initFromNode.call(this,t,null,e,n),null!==t.head&&null!==t.head.styling&&U(t.head.styling,D(e),this.styleAttrs,n)},S.prototype.initFromNode=function(t,e,n,i){T.prototype.initFromNode.call(this,t,e,n,i);var r=R(n,i);for(var o in this.qname=null,this.value=null,r){if(this.qname){B(i,"More than one style specified on set");break}this.qname=o,this.value=r[o]}}}(e,"undefined"==typeof sax?l:sax,"undefined"==typeof imscNames?i:imscNames,"undefined"==typeof imscStyles?o:imscStyles,"undefined"==typeof imscUtils?r:imscUtils)})),u=n((function(t,e){!function(t,e,n){function i(t,e,l){var u;if("region"===l.kind)(u=document.createElement("div")).style.position="absolute";else if("body"===l.kind)u=document.createElement("div");else if("div"===l.kind)u=document.createElement("div");else if("image"===l.kind){if(u=document.createElement("img"),null!==t.imgResolver&&null!==l.src){var c=t.imgResolver(l.src,u);c&&(u.src=c),u.height=t.regionH,u.width=t.regionW}}else if("p"===l.kind)u=document.createElement("p");else if("span"===l.kind){if("container"===l.styleAttrs[n.byName.ruby.qname])u=document.createElement("ruby"),t.ruby=!0;else if("base"===l.styleAttrs[n.byName.ruby.qname])u=document.createElement("rb");else if("text"===l.styleAttrs[n.byName.ruby.qname])u=document.createElement("rt");else if("baseContainer"===l.styleAttrs[n.byName.ruby.qname])u=document.createElement("rbc");else if("textContainer"===l.styleAttrs[n.byName.ruby.qname])u=document.createElement("rtc");else{if("delimiter"===l.styleAttrs[n.byName.ruby.qname])return;u=document.createElement("span")}var p=l.styleAttrs[n.byName.textEmphasis.qname];p&&"none"!==p.style&&(t.textEmphasis=!0)}else"br"===l.kind&&(u=document.createElement("br"));if(u){for(var f in e.appendChild(u),u.style.margin="0",a){var d=a[f],m=l.styleAttrs[d.qname];void 0!==m&&null!==d.map&&d.map(t,u,l,m)}var h=u;if("region"===l.kind){var g=l.styleAttrs[n.byName.writingMode.qname];"lrtb"===g||"lr"===g?(t.ipd="lr",t.bpd="tb"):"rltb"===g||"rl"===g?(t.ipd="rl",t.bpd="tb"):"tblr"===g?(t.ipd="tb",t.bpd="lr"):"tbrl"!==g&&"tb"!==g||(t.ipd="tb",t.bpd="rl")}var y=l.styleAttrs[n.byName.linePadding.qname];if(y&&!y.isZero()){var b=y.toUsedLength(t.w,t.h);if(b>0){var w=Math.ceil(b)+"px";"tb"===t.bpd?(h.style.paddingLeft=w,h.style.paddingRight=w):(h.style.paddingTop=w,h.style.paddingBottom=w),t.lp=y}}var v=l.styleAttrs[n.byName.multiRowAlign.qname];if(v&&"auto"!==v){var N=document.createElement("span");N.style.display="inline-block",N.style.textAlign=v,u.appendChild(N),h=N,t.mra=v}var T=l.styleAttrs[n.byName.rubyReserve.qname];if(T&&"none"!==T[0]&&(t.rubyReserve=T),l.styleAttrs[n.byName.fillLineGap.qname]&&(t.flg=!0),"span"===l.kind&&l.text)if(n.byName.textCombine.qname in l.styleAttrs&&"all"===l.styleAttrs[n.byName.textCombine.qname][0])u.textContent=l.text;else for(var x="",_=0;_<l.text.length;_++){x+=l.text.charAt(_);var A=l.text.charCodeAt(_);if(A<55296||A>56319||_===l.text.length){var E=document.createElement("span");E.textContent=x,u.appendChild(E),x=""}}for(var C in l.contents)i(t,h,l.contents[C]);var I=[];if((t.lp||t.mra||t.flg||t.ruby||t.textEmphasis||t.rubyReserve)&&"p"===l.kind&&(s(t,h,I,null),t.rubyReserve&&(!function(t,e){for(var n=0;n<t.length;n++){var i,r,o=document.createElement("ruby"),s=document.createElement("rb");s.textContent="​",o.appendChild(s);var l=e.rubyReserve[1].toUsedLength(e.w,e.h)+"px";"both"===e.rubyReserve[0]?((i=document.createElement("rtc")).style.rubyPosition="under",i.textContent="​",i.style.fontSize=l,(r=document.createElement("rtc")).style.rubyPosition="over",r.textContent="​",r.style.fontSize=l,o.appendChild(i),o.appendChild(r)):((i=document.createElement("rtc")).textContent="​",i.style.fontSize=l,"after"===e.rubyReserve[0]||"outside"===e.rubyReserve[0]&&n>0?i.style.rubyPosition="tb"===e.bpd||"rl"===e.bpd?"under":"over":i.style.rubyPosition="tb"===e.bpd||"rl"===e.bpd?"over":"under",o.appendChild(i));t[n].elements[0].node.parentElement.insertBefore(o,t[n].elements[0].node)}}(I,t),t.rubyReserve=null),(t.ruby||t.rubyReserve)&&(!function(t,e){for(var n=0;n<t.length;n++)for(var i=0;i<t[n].rbc.length;i++){var r;if(!t[n].rbc[i].style.rubyPosition)r="tb"===e.bpd||"rl"===e.bpd?0===n?"over":"under":0===n?"under":"over",t[n].rbc[i].style.rubyPosition=r}}(I,t),t.ruby=null),t.textEmphasis&&(!function(t,e){for(var n=0;n<t.length;n++)for(var i=0;i<t[n].te.length;i++){var r;if(!t[n].te[i].style.textEmphasisPosition||"none"===t[n].te[i].style.textEmphasisPosition)r="tb"===e.bpd?0===n?"left over":"left under":"rl"===e.bpd?0===n?"right under":"left under":0===n?"left under":"right under",t[n].te[i].style.textEmphasisPosition=r}}(I,t),t.textEmphasis=null),t.mra&&(!function(t){for(var e=0;e<t.length-1;e++){var n=t[e].elements.length;if(0!==n&&!1===t[e].br){var i=document.createElement("br"),r=t[e].elements[n-1].node;r.parentElement.insertBefore(i,r.nextSibling)}}}(I),t.mra=null),t.lp&&(!function(t,e,n){for(var i in t){var r=t[i].elements.length,o=t[i].elements[t[i].start_elem],s=t[i].elements[t[i].end_elem],l=Math.ceil(e)+"px",a="-"+Math.ceil(e)+"px";0!==r&&("lr"===n.ipd?(o.node.style.borderLeftColor=o.bgcolor||"#00000000",o.node.style.borderLeftStyle="solid",o.node.style.borderLeftWidth=l,o.node.style.marginLeft=a):"rl"===n.ipd?(o.node.style.borderRightColor=o.bgcolor||"#00000000",o.node.style.borderRightStyle="solid",o.node.style.borderRightWidth=l,o.node.style.marginRight=a):"tb"===n.ipd&&(o.node.style.borderTopColor=o.bgcolor||"#00000000",o.node.style.borderTopStyle="solid",o.node.style.borderTopWidth=l,o.node.style.marginTop=a),"lr"===n.ipd?(s.node.style.borderRightColor=s.bgcolor||"#00000000",s.node.style.borderRightStyle="solid",s.node.style.borderRightWidth=l,s.node.style.marginRight=a):"rl"===n.ipd?(s.node.style.borderLeftColor=s.bgcolor||"#00000000",s.node.style.borderLeftStyle="solid",s.node.style.borderLeftWidth=l,s.node.style.marginLeft=a):"tb"===n.ipd&&(s.node.style.borderBottomColor=s.bgcolor||"#00000000",s.node.style.borderBottomStyle="solid",s.node.style.borderBottomWidth=l,s.node.style.marginBottom=a))}}(I,t.lp.toUsedLength(t.w,t.h),t),t.lp=null),t.flg)){var L=o(h.getBoundingClientRect(),t);!function(t,e,n,i){for(var r=Math.sign(n-e),o=0;o<=t.length;o++){var s,l,a;if(s=0===o?e:o===t.length?n:(t[o].before+t[o-1].after)/2,o>0)for(var u=0;u<t[o-1].elements.length;u++)null!==t[o-1].elements[u].bgcolor&&r*((a=t[o-1].elements[u]).after-s)<0&&(l=Math.ceil(Math.abs(s-a.after))+"px",a.node.style.backgroundColor=a.bgcolor,"lr"===i.bpd?a.node.style.paddingRight=l:"rl"===i.bpd?a.node.style.paddingLeft=l:"tb"===i.bpd&&(a.node.style.paddingBottom=l));if(o<t.length)for(var c=0;c<t[o].elements.length;c++)null!==(a=t[o].elements[c]).bgcolor&&r*(a.before-s)>0&&(l=Math.ceil(Math.abs(a.before-s))+"px",a.node.style.backgroundColor=a.bgcolor,"lr"===i.bpd?a.node.style.paddingLeft=l:"rl"===i.bpd?a.node.style.paddingRight=l:"tb"===i.bpd&&(a.node.style.paddingTop=l))}}(I,L.before,L.after,t),t.flg=null}if("region"===l.kind&&(s(t,h,I),"tb"===t.bpd&&t.enableRollUp&&l.contents.length>0&&"after"===l.styleAttrs[n.byName.displayAlign.qname])){var S=new r(""===l.id?"_":l.id,I);if(t.currentISDState[S.id]=S,t.previousISDState&&S.id in t.previousISDState&&t.previousISDState[S.id].plist.length>0&&S.plist.length>1&&S.plist[S.plist.length-2].text===t.previousISDState[S.id].plist[t.previousISDState[S.id].plist.length-1].text){var F=u.firstElementChild,D=S.plist[S.plist.length-1].after-S.plist[S.plist.length-1].before;F.style.bottom="-"+D+"px",F.style.transition="transform 0.4s",F.style.position="relative",F.style.transform="translateY(-"+D+"px)"}}}else!function(t,e){if(t&&t.error&&t.error(e))throw e}(t.errorHandler,"Error processing ISD element kind: "+l.kind)}function r(t,e){this.id=t,this.plist=e}function o(t,e){var n={before:null,after:null,start:null,end:null};return"tb"===e.bpd?(n.before=t.top,n.after=t.bottom,"lr"===e.ipd?(n.start=t.left,n.end=t.right):(n.start=t.right,n.end=t.left)):"lr"===e.bpd?(n.before=t.left,n.after=t.right,n.start=t.top,n.end=t.bottom):"rl"===e.bpd&&(n.before=t.right,n.after=t.left,n.start=t.top,n.end=t.bottom),n}function s(t,e,n,i){if("rt"!==e.localName&&"rtc"!==e.localName){var r,l,a,u,c=e.style.backgroundColor||i;if(0===e.childElementCount)if("span"===e.localName||"rb"===e.localName){var p=e.getBoundingClientRect();if(0===p.height||0===p.width)return;var f=o(p,t);if(0!==n.length&&(r=f.before,l=f.after,a=n[n.length-1].before,u=n[n.length-1].after,l<u&&r>a||u<=l&&a>=r)){var d=Math.sign(f.after-f.before),m=Math.sign(f.end-f.start);d*(f.before-n[n.length-1].before)<0&&(n[n.length-1].before=f.before),d*(f.after-n[n.length-1].after)>0&&(n[n.length-1].after=f.after),m*(f.start-n[n.length-1].start)<0&&(n[n.length-1].start=f.start,n[n.length-1].start_elem=n[n.length-1].elements.length),m*(f.end-n[n.length-1].end)>0&&(n[n.length-1].end=f.end,n[n.length-1].end_elem=n[n.length-1].elements.length)}else n.push({before:f.before,after:f.after,start:f.start,end:f.end,start_elem:0,end_elem:0,elements:[],rbc:[],te:[],text:"",br:!1});n[n.length-1].text+=e.textContent,n[n.length-1].elements.push({node:e,bgcolor:c,before:f.before,after:f.after})}else"br"===e.localName&&0!==n.length&&(n[n.length-1].br=!0);else for(var h=e.firstChild;h;)h.nodeType===Node.ELEMENT_NODE&&(s(t,h,n,c),"ruby"===h.localName||"rtc"===h.localName?n.length>0&&n[n.length-1].rbc.push(h):"span"===h.localName&&h.style.textEmphasisStyle&&"none"!==h.style.textEmphasisStyle&&n.length>0&&n[n.length-1].te.push(h)),h=h.nextSibling}}function l(t,e){this.qname=t,this.map=e}t.render=function(t,e,n,r,o,s,l,a,u){var c=r||e.clientHeight,p=o||e.clientWidth;if(null!==t.aspectRatio){var f=c*t.aspectRatio;f>p?c=Math.round(p/t.aspectRatio):p=f}var d=document.createElement("div");d.style.position="relative",d.style.width=p+"px",d.style.height=c+"px",d.style.margin="auto",d.style.top=0,d.style.bottom=0,d.style.left=0,d.style.right=0,d.style.zIndex=0;var m={h:c,w:p,regionH:null,regionW:null,imgResolver:n,displayForcedOnlyMode:s||!1,isd:t,errorHandler:l,previousISDState:a,enableRollUp:u||!1,currentISDState:{},flg:null,lp:null,mra:null,ipd:null,bpd:null,ruby:null,textEmphasis:null,rubyReserve:null};for(var h in e.appendChild(d),t.contents)i(m,d,t.contents[h]);return m.currentISDState};var a=[new l("http://www.w3.org/ns/ttml#styling backgroundColor",(function(t,e,n,i){0!==i[3]&&(e.style.backgroundColor="rgba("+i[0].toString()+","+i[1].toString()+","+i[2].toString()+","+(i[3]/255).toString()+")")})),new l("http://www.w3.org/ns/ttml#styling color",(function(t,e,n,i){e.style.color="rgba("+i[0].toString()+","+i[1].toString()+","+i[2].toString()+","+(i[3]/255).toString()+")"})),new l("http://www.w3.org/ns/ttml#styling direction",(function(t,e,n,i){e.style.direction=i})),new l("http://www.w3.org/ns/ttml#styling display",(function(t,e,n,i){})),new l("http://www.w3.org/ns/ttml#styling displayAlign",(function(t,e,n,i){e.style.display="flex",e.style.flexDirection="column","before"===i?e.style.justifyContent="flex-start":"center"===i?e.style.justifyContent="center":"after"===i&&(e.style.justifyContent="flex-end")})),new l("http://www.w3.org/ns/ttml#styling extent",(function(t,e,n,i){t.regionH=i.h.toUsedLength(t.w,t.h),t.regionW=i.w.toUsedLength(t.w,t.h);var r=0,o=0,s=n.styleAttrs["http://www.w3.org/ns/ttml#styling padding"];s&&(r=s[0].toUsedLength(t.w,t.h)+s[2].toUsedLength(t.w,t.h),o=s[1].toUsedLength(t.w,t.h)+s[3].toUsedLength(t.w,t.h)),e.style.height=t.regionH-r+"px",e.style.width=t.regionW-o+"px"})),new l("http://www.w3.org/ns/ttml#styling fontFamily",(function(t,e,n,i){var r=[];for(var o in i)i[o]=i[o].trim(),"monospaceSerif"===i[o]?(r.push("Courier New"),r.push('"Liberation Mono"'),r.push("Courier"),r.push("monospace")):"proportionalSansSerif"===i[o]||"default"===i[o]?(r.push("Arial"),r.push("Helvetica"),r.push('"Liberation Sans"'),r.push("sans-serif")):"monospace"===i[o]?r.push("monospace"):"sansSerif"===i[o]?r.push("sans-serif"):"serif"===i[o]?r.push("serif"):"monospaceSansSerif"===i[o]?(r.push("Consolas"),r.push("monospace")):"proportionalSerif"===i[o]?r.push("serif"):r.push(i[o]);e.style.fontFamily=r.join(",")})),new l("http://www.w3.org/ns/ttml#styling shear",(function(t,e,n,i){if(0!==i){var r=-.9*i;"tb"===t.bpd?e.style.transform="skewX("+r+"deg)":e.style.transform="skewY("+r+"deg)"}})),new l("http://www.w3.org/ns/ttml#styling fontSize",(function(t,e,n,i){e.style.fontSize=i.toUsedLength(t.w,t.h)+"px"})),new l("http://www.w3.org/ns/ttml#styling fontStyle",(function(t,e,n,i){e.style.fontStyle=i})),new l("http://www.w3.org/ns/ttml#styling fontWeight",(function(t,e,n,i){e.style.fontWeight=i})),new l("http://www.w3.org/ns/ttml#styling lineHeight",(function(t,e,n,i){e.style.lineHeight="normal"===i?"normal":i.toUsedLength(t.w,t.h)+"px"})),new l("http://www.w3.org/ns/ttml#styling opacity",(function(t,e,n,i){e.style.opacity=i})),new l("http://www.w3.org/ns/ttml#styling origin",(function(t,e,n,i){e.style.top=i.h.toUsedLength(t.w,t.h)+"px",e.style.left=i.w.toUsedLength(t.w,t.h)+"px"})),new l("http://www.w3.org/ns/ttml#styling overflow",(function(t,e,n,i){e.style.overflow=i})),new l("http://www.w3.org/ns/ttml#styling padding",(function(t,e,n,i){var r=[];r[0]=i[0].toUsedLength(t.w,t.h)+"px",r[1]=i[3].toUsedLength(t.w,t.h)+"px",r[2]=i[2].toUsedLength(t.w,t.h)+"px",r[3]=i[1].toUsedLength(t.w,t.h)+"px",e.style.padding=r.join(" ")})),new l("http://www.w3.org/ns/ttml#styling position",(function(t,e,n,i){e.style.top=i.h.toUsedLength(t.w,t.h)+"px",e.style.left=i.w.toUsedLength(t.w,t.h)+"px"})),new l("http://www.w3.org/ns/ttml#styling rubyAlign",(function(t,e,n,i){e.style.rubyAlign=i})),new l("http://www.w3.org/ns/ttml#styling rubyPosition",(function(t,e,n,i){var r;"before"!==i&&"after"!==i||(r="tb"===t.bpd||"rl"===t.bpd?"before"===i?"over":"under":"before"===i?"under":"over",e.parentElement.style.rubyPosition=r)})),new l("http://www.w3.org/ns/ttml#styling showBackground",null),new l("http://www.w3.org/ns/ttml#styling textAlign",(function(t,e,i,r){var o,s=i.styleAttrs[n.byName.direction.qname];o="start"===r?"rtl"===s?"right":"left":"end"===r?"rtl"===s?"left":"right":r,e.style.textAlign=o})),new l("http://www.w3.org/ns/ttml#styling textDecoration",(function(t,e,n,i){e.style.textDecoration=i.join(" ").replace("lineThrough","line-through")})),new l("http://www.w3.org/ns/ttml#styling textOutline",(function(t,e,n,i){})),new l("http://www.w3.org/ns/ttml#styling textShadow",(function(t,e,i,r){var o=i.styleAttrs[n.byName.textOutline.qname];if("none"===r&&"none"===o)e.style.textShadow="";else{var s=[];if("none"!==o&&s.push("rgba("+o.color[0].toString()+","+o.color[1].toString()+","+o.color[2].toString()+","+(o.color[3]/255).toString()+") 0px 0px "+o.thickness.toUsedLength(t.w,t.h)+"px"),"none"!==r)for(var l in r)s.push(r[l].x_off.toUsedLength(t.w,t.h)+"px "+r[l].y_off.toUsedLength(t.w,t.h)+"px "+r[l].b_radius.toUsedLength(t.w,t.h)+"px rgba("+r[l].color[0].toString()+","+r[l].color[1].toString()+","+r[l].color[2].toString()+","+(r[l].color[3]/255).toString()+")");e.style.textShadow=s.join(",")}})),new l("http://www.w3.org/ns/ttml#styling textCombine",(function(t,e,n,i){e.style.textCombineUpright=i.join(" ")})),new l("http://www.w3.org/ns/ttml#styling textEmphasis",(function(t,e,n,i){var r;"none"!==i.style?("auto"===i.style?e.style.textEmphasisStyle="filled":e.style.textEmphasisStyle=i.style+" "+i.symbol,("before"===i.position||"after"===i.position)&&(r="tb"===t.bpd?"before"===i.position?"left over":"left under":"rl"===t.bpd?"before"===i.position?"right under":"left under":"before"===i.position?"left under":"right under",e.style.textEmphasisPosition=r)):e.style.textEmphasisStyle="none"})),new l("http://www.w3.org/ns/ttml#styling unicodeBidi",(function(t,e,n,i){var r;r="bidiOverride"===i?"bidi-override":i,e.style.unicodeBidi=r})),new l("http://www.w3.org/ns/ttml#styling visibility",(function(t,e,n,i){e.style.visibility=i})),new l("http://www.w3.org/ns/ttml#styling wrapOption",(function(t,e,n,i){"wrap"===i?"preserve"===n.space?e.style.whiteSpace="pre-wrap":e.style.whiteSpace="normal":"preserve"===n.space?e.style.whiteSpace="pre":e.style.whiteSpace="noWrap"})),new l("http://www.w3.org/ns/ttml#styling writingMode",(function(t,e,n,i){"lrtb"===i||"lr"===i||"rltb"===i||"rl"===i?t.writingMode="horizontal-tb":"tblr"===i?t.writingMode="vertical-lr":"tbrl"!==i&&"tb"!==i||(t.writingMode="vertical-rl"),e.style.writingMode=t.writingMode})),new l("http://www.w3.org/ns/ttml#styling zIndex",(function(t,e,n,i){e.style.zIndex=i})),new l("http://www.w3.org/ns/ttml/profile/imsc1#styling forcedDisplay",(function(t,e,n,i){t.displayForcedOnlyMode&&!1===i&&(e.style.visibility="hidden")}))],u={};for(var c in a)u[a[c].qname]=a[c]}(e,"undefined"==typeof imscNames||imscNames,"undefined"==typeof imscStyles?o:imscStyles,"undefined"==typeof imscUtils||imscUtils)})),c=s.generateISD,p=a.fromXML,f=u.render,d={generateISD:c,fromXML:p,renderHTML:f};export default d;export{p as fromXML,c as generateISD,f as renderHTML};
